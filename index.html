<!DOCTYPE html>
<html>
<head>
    <title>MSM Failed Charges Dashboard - FIXED</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: 0; min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .header { background: linear-gradient(135deg, #52130C 0%, #713718 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.2em; margin-bottom: 10px; font-weight: 700; }
        .stats { background: #f8f9fa; padding: 20px; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px; border-bottom: 1px solid #dee2e6; }
        .stat { text-align: center; }
        .stat-number { font-size: 2em; font-weight: bold; color: #52130C; display: block; }
        .stat-label { color: #6c757d; font-size: 0.9em; margin-top: 5px; }
        .controls { padding: 20px; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; gap: 15px; flex-wrap: wrap; }
        .search { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; width: 300px; }
        .refresh-btn { padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #dee2e6; }
        th { background: #f8f9fa; font-weight: 600; color: #495057; }
        tr:hover { background: #f8f9fa; }
        .amount { font-size: 1.1em; font-weight: bold; color: #dc3545; }
        .status { background: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; font-weight: 500; }
        .status-contacted { background: #d1ecf1; color: #0c5460; }
        .btn { padding: 5px 10px; font-size: 0.8em; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-block; margin: 2px; }
        .btn-email { background: #007bff; color: white; }
        .btn-call { background: #28a745; color: white; }
        .btn-resolve { background: #dc3545; color: white; }
        .loading { text-align: center; color: #6c757d; padding: 40px; }
        .error { text-align: center; color: #dc3545; padding: 20px; background: #f8d7da; margin: 20px; border-radius: 6px; }
        .debug { background: #e9ecef; padding: 15px; margin: 20px; border-radius: 6px; font-family: monospace; font-size: 0.9em; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö® MSM Failed Charges Dashboard</h1>
            <p>Payment Recovery & Customer Management System</p>
        </div>
        
        <div id="debugInfo" class="debug">
            <strong>üîß Debug Log:</strong><br>
            Initializing...
        </div>

        <div class="stats">
            <div class="stat">
                <span id="totalFailed" class="stat-number">-</span>
                <div class="stat-label">Failed Charges</div>
            </div>
            <div class="stat">
                <span id="totalAmount" class="stat-number">-</span>
                <div class="stat-label">Amount At Risk</div>
            </div>
            <div class="stat">
                <span id="resolvedCount" class="stat-number">-</span>
                <div class="stat-label">Resolved</div>
            </div>
            <div class="stat">
                <span id="recoveryRate" class="stat-number">-</span>
                <div class="stat-label">Recovery Rate</div>
            </div>
        </div>

        <div class="controls">
            <input type="text" id="searchInput" class="search" placeholder="Search by name or email...">
            <button id="refreshBtn" class="refresh-btn">üîÑ Refresh</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Customer</th>
                    <th>Failed Date</th>
                    <th>Failed Amount</th>
                    <th>Paid to Date</th>
                    <th>Remaining</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="chargesTableBody">
                <tr>
                    <td colspan="7" class="loading">Loading failed charges...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        // Global variables - declared once to avoid syntax errors
        let dbClient = null;
        let chargesData = [];

        // Debug logging function
        function addDebugLog(message) {
            console.log('[MSM Dashboard]', message);
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML += '<br>' + new Date().toLocaleTimeString() + ': ' + message;
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }

        // Initialize the dashboard
        function initDashboard() {
            addDebugLog('üöÄ Starting MSM Dashboard initialization...');

            try {
                // Check if Supabase library is loaded
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Supabase library not loaded');
                }
                addDebugLog('‚úÖ Supabase library loaded successfully');

                // Create Supabase client (only once)
                dbClient = window.supabase.createClient(
                    'https://hwfhcznrpqdldlcqcvro.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh3Zmhjem5ycHFkbGRsY3FjdnJvIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MjE0MDYzNCwiZXhwIjoyMDg3NzE2NjM0fQ.FsXw5uCOc1s7MKYj9je4GBZPJLgx0u3OMgGbd_1iRB4'
                );
                addDebugLog('‚úÖ Supabase client created successfully');

                // Load data
                loadCharges();

                // Set up event listeners
                setupEventListeners();

                addDebugLog('‚úÖ Dashboard initialization complete');

            } catch (error) {
                addDebugLog('‚ùå Initialization error: ' + error.message);
                showError('Failed to initialize dashboard: ' + error.message);
            }
        }

        // Load failed charges from database
        async function loadCharges() {
            try {
                addDebugLog('üîç Querying database for failed charges...');

                const { data, error } = await dbClient
                    .from('failed_charges')
                    .select('*')
                    .eq('resolved', false)
                    .order('failure_date', { ascending: false });

                addDebugLog('üìä Database query completed');

                if (error) {
                    throw error;
                }

                if (!data) {
                    addDebugLog('‚ö†Ô∏è No data returned from database');
                    chargesData = [];
                } else {
                    addDebugLog('‚úÖ Successfully loaded ' + data.length + ' failed charges');
                    chargesData = data;
                }

                // Update UI
                updateTable();
                updateStats();

            } catch (error) {
                addDebugLog('‚ùå Database query error: ' + error.message);
                showError('Database error: ' + error.message);
            }
        }

        // Update the table with current data
        function updateTable() {
            const tbody = document.getElementById('chargesTableBody');
            
            if (chargesData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">No failed charges found.</td></tr>';
                return;
            }

            tbody.innerHTML = chargesData.map(charge => {
                const failureDate = new Date(charge.failure_date).toLocaleDateString();
                const customerName = charge.customer_name || 'Unknown Customer';
                const customerEmail = charge.customer_email || '';
                const failedAmount = parseFloat(charge.failed_amount || 0);
                const totalPaid = parseFloat(charge.total_paid || 0);
                const remainingBalance = parseFloat(charge.remaining_balance || 0);
                const status = charge.recovery_status || 'pending';
                const reason = charge.failure_reason || 'Payment failed';
                
                return `
                    <tr>
                        <td>
                            <strong style="color: #52130C;">${customerName}</strong><br>
                            <small style="color: #6c757d;">${customerEmail}</small><br>
                            <small style="color: #dc3545;">${reason}</small>
                        </td>
                        <td>${failureDate}</td>
                        <td class="amount">$${failedAmount.toLocaleString()}</td>
                        <td>$${totalPaid.toLocaleString()}</td>
                        <td>$${remainingBalance.toLocaleString()}</td>
                        <td><span class="status status-${status}">${status.charAt(0).toUpperCase() + status.slice(1)}</span></td>
                        <td>
                            <a href="mailto:${customerEmail}?subject=Payment Recovery - ${customerName}" class="btn btn-email">Email</a>
                            <button class="btn btn-call" onclick="updateChargeStatus(${charge.id}, 'contacted', '${customerName}')">Call</button>
                            <button class="btn btn-resolve" onclick="resolveCharge(${charge.id}, '${customerName}')">Resolve</button>
                        </td>
                    </tr>
                `;
            }).join('');

            addDebugLog('‚úÖ Table updated with ' + chargesData.length + ' charges');
        }

        // Update statistics
        function updateStats() {
            const totalFailed = chargesData.length;
            const totalAmount = chargesData.reduce((sum, charge) => 
                sum + parseFloat(charge.failed_amount || 0), 0);

            document.getElementById('totalFailed').textContent = totalFailed;
            document.getElementById('totalAmount').textContent = '$' + totalAmount.toLocaleString();
            document.getElementById('resolvedCount').textContent = '0';
            document.getElementById('recoveryRate').textContent = '0%';

            addDebugLog('üìä Stats updated - Total: ' + totalFailed + ', Amount: $' + totalAmount.toLocaleString());
        }

        // Set up event listeners
        function setupEventListeners() {
            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', function() {
                addDebugLog('üîÑ Manual refresh triggered');
                loadCharges();
            });

            // Search functionality
            document.getElementById('searchInput').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                // Simple search implementation can be added here
                addDebugLog('üîç Search: ' + searchTerm);
            });

            addDebugLog('‚úÖ Event listeners set up');
        }

        // Update charge status
        async function updateChargeStatus(chargeId, status, customerName) {
            try {
                addDebugLog(`Updating ${customerName} (ID: ${chargeId}) to status: ${status}`);
                
                const { error } = await dbClient
                    .from('failed_charges')
                    .update({ 
                        recovery_status: status,
                        updated_at: new Date().toISOString() 
                    })
                    .eq('id', chargeId);

                if (error) throw error;
                
                alert(`‚úÖ ${customerName} status updated to ${status}!`);
                loadCharges(); // Reload data
                
            } catch (error) {
                addDebugLog(`‚ùå Error updating ${customerName}: ${error.message}`);
                alert('‚ùå Error updating status: ' + error.message);
            }
        }

        // Resolve charge
        async function resolveCharge(chargeId, customerName) {
            if (confirm(`Mark ${customerName}'s charge as resolved?`)) {
                try {
                    addDebugLog(`Resolving charge for ${customerName} (ID: ${chargeId})`);
                    
                    const { error } = await dbClient
                        .from('failed_charges')
                        .update({ 
                            resolved: true,
                            recovery_status: 'resolved',
                            resolved_date: new Date().toISOString() 
                        })
                        .eq('id', chargeId);
                    
                    if (error) throw error;
                    
                    alert(`‚úÖ ${customerName} charge resolved!`);
                    loadCharges(); // Reload data
                } catch (error) {
                    addDebugLog(`‚ùå Error resolving ${customerName}: ${error.message}`);
                    alert('‚ùå Error resolving charge: ' + error.message);
                }
            }
        }

        // Show error message
        function showError(message) {
            document.getElementById('chargesTableBody').innerHTML = 
                '<tr><td colspan="7" class="error">‚ùå ' + message + '</td></tr>';
        }

        // Start the dashboard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            addDebugLog('üìÑ DOM loaded, starting dashboard...');
            initDashboard();
        });

        // Also start immediately in case DOMContentLoaded already fired
        if (document.readyState === 'loading') {
            addDebugLog('üìÑ Document still loading, waiting for DOMContentLoaded...');
        } else {
            addDebugLog('üìÑ Document ready, starting dashboard immediately...');
            initDashboard();
        }
    </script>
</body>
</html>